<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Kick</title>
    <style>
      html, body {
        height: 100%;
        margin: 0;
        display: grid;
        place-items: center;
        font-family: system-ui, sans-serif;
        background: #0b0b10;
      }
      button {
        font-size: 48px;
        padding: 22px 44px;
        border-radius: 18px;
        border: 0;
        cursor: pointer;
      }
      .hint {
        position: fixed;
        bottom: 16px;
        opacity: 0.7;
        color: white;
        font-size: 14px;
      }
    </style>
  </head>

  <body>
    <button id="kickBtn">Kick</button>
    <div class="hint" id="status">Connecting…</div>

    <script type="module">
      // Fill these in (same as overlay page)
      const SUPABASE_URL = "https://rcwvicblzidaukglxquu.supabase.co";
      const SUPABASE_ANON_KEY = "sb_publishable_7to8QZuk22ORD8SnfiSRjg_U7f7EeQ0";

      const CHANNEL = "angerfoot-kick";
      const EVENT = "kick";

      const statusEl = document.getElementById("status");
      const btn = document.getElementById("kickBtn");

      const { createClient } = await import("https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm");
      const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

      const channel = supabase.channel(CHANNEL);

      btn.disabled = true;

      const { error } = await channel.subscribe((status) => {
        if (status === "SUBSCRIBED") {
          statusEl.textContent = "Connected";
          btn.disabled = false;
        } else if (status === "TIMED_OUT") {
          statusEl.textContent = "Timed out… retrying";
        } else if (status === "CHANNEL_ERROR") {
          statusEl.textContent = "Channel error";
        } else if (status === "CLOSED") {
          statusEl.textContent = "Disconnected";
          btn.disabled = true;
        }
      });

      if (error) {
        console.error(error);
        statusEl.textContent = "Failed to connect";
      }

      // Optional: local per-user rate limit so one person can't spam-click
      const LOCAL_COOLDOWN_MS = 250;
      let lastSent = 0;

      btn.addEventListener("click", async () => {
        const now = Date.now();
        if (now - lastSent < LOCAL_COOLDOWN_MS) return;
        lastSent = now;

        // Broadcast to everyone listening (including multiple OBS instances)
        const { error: sendErr } = await channel.send({
          type: "broadcast",
          event: EVENT,
          payload: { at: now },
        });

        if (sendErr) console.error("Send error:", sendErr);
      });
    </script>
  </body>
</html>
