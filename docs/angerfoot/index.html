<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Kick</title>
    <style>
      img {
        position: relative;
      }

      .hint {
        display: none;
        position: fixed;
        bottom: 16px;
        opacity: 0.7;
        color: white;
      }
    </style>
  </head>

  <body>
    <button
      id="kickBtn"
      style="
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%) scale(1);
        transform-origin: center;
        background: none;
        border: none;
        cursor: pointer;

        /* smooth but snappy */
        transition: transform 90ms cubic-bezier(0.2, 0.8, 0.2, 1);
        will-change: transform;
      "
    >
      <img src="kick.svg" style="width: 300px" />
    </button>

    <div class="hint" id="status">Connecting…</div>

    <script type="module">
      // Fill these in (same as overlay page)
      const SUPABASE_URL = "https://rcwvicblzidaukglxquu.supabase.co";
      const SUPABASE_ANON_KEY =
        "sb_publishable_7to8QZuk22ORD8SnfiSRjg_U7f7EeQ0";

      const CHANNEL = "angerfoot-kick";
      const EVENT = "kick";

      const statusEl = document.getElementById("status");
      const btn = document.getElementById("kickBtn");

      const { createClient } =
        await import("https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm");
      const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

      const channel = supabase.channel(CHANNEL);

      btn.disabled = true;

      const { error } = await channel.subscribe((status) => {
        if (status === "SUBSCRIBED") {
          statusEl.textContent = "Connected";
          btn.disabled = false;
        } else if (status === "TIMED_OUT") {
          statusEl.textContent = "Timed out… retrying";
        } else if (status === "CHANNEL_ERROR") {
          statusEl.textContent = "Channel error";
        } else if (status === "CLOSED") {
          statusEl.textContent = "Disconnected";
          btn.disabled = true;
        }
      });

      if (error) {
        console.error(error);
        statusEl.textContent = "Failed to connect";
      }

      // Optional: local per-user rate limit so one person can't spam-click
      const LOCAL_COOLDOWN_MS = 250;
      let lastSent = 0;

      btn.addEventListener("click", async () => {
        const now = Date.now();
        if (now - lastSent < LOCAL_COOLDOWN_MS) return;
        lastSent = now;

        // Broadcast to everyone listening (including multiple OBS instances)
        const { error: sendErr } = await channel.send({
          type: "broadcast",
          event: EVENT,
          payload: { at: now },
        });

        if (sendErr) console.error("Send error:", sendErr);
      });

      (function () {
        const btn = document.getElementById("kickBtn");

        // Base translate must always be included so we don't fight layout/positioning.
        const BASE = "translate(-50%, -50%)";
        const SCALE = {
          up: 1.0,
          hover: 1.01,
          down: 0.97,
        };

        let hovered = false;
        let down = false;

        function apply() {
          const s = down ? SCALE.down : hovered ? SCALE.hover : SCALE.up;
          btn.style.transform = `${BASE} scale(${s})`;
        }

        // Hover state
        btn.addEventListener("mouseenter", () => {
          hovered = true;
          apply();
        });
        btn.addEventListener("mouseleave", () => {
          hovered = false;
          down = false; // if they drag out while holding
          apply();
        });

        // Press state (mouse)
        btn.addEventListener("mousedown", (e) => {
          if (e.button !== 0) return; // left click only
          down = true;
          apply();

          // If mouseup happens off-button, reset.
          const onUp = () => {
            down = false;
            apply();
            cleanup();
          };
          const onBlur = () => {
            down = false;
            apply();
            cleanup();
          };
          function cleanup() {
            window.removeEventListener("mouseup", onUp, true);
            window.removeEventListener("blur", onBlur, true);
          }

          window.addEventListener("mouseup", onUp, true);
          window.addEventListener("blur", onBlur, true);
        });

        // Touch/pen/trackpad (pointer events) — robust for fast taps
        btn.addEventListener("pointerdown", (e) => {
          // avoid double-firing with mousedown on some browsers: ignore mouse pointers here
          if (e.pointerType === "mouse") return;
          down = true;
          apply();
          btn.setPointerCapture?.(e.pointerId);
        });

        btn.addEventListener("pointerup", (e) => {
          if (e.pointerType === "mouse") return;
          down = false;
          apply();
          btn.releasePointerCapture?.(e.pointerId);
        });

        btn.addEventListener("pointercancel", (e) => {
          if (e.pointerType === "mouse") return;
          down = false;
          apply();
        });

        // Keyboard press (Space/Enter)
        btn.addEventListener("keydown", (e) => {
          if (e.repeat) return;
          if (e.key === " " || e.key === "Enter") {
            down = true;
            apply();
          }
        });
        btn.addEventListener("keyup", (e) => {
          if (e.key === " " || e.key === "Enter") {
            down = false;
            apply();
          }
        });

        // Init
        apply();
      })();
    </script>
  </body>
</html>
