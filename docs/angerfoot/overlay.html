<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />

    <style>
      @font-face {
        font-family: "AngerFoot";
        src: url("Anger-Foot.woff") format("woff");
        font-weight: normal;
        font-style: normal;
      }

      img {
        position: absolute;
      }

      * {
        font-family: "AngerFoot", sans-serif;
        color: #f11672;
      }

      html,
      body {
        margin: 0;
        padding: 0;
        background: transparent;
      }

      #sep {
        margin: -5px;
      }

      #clock {
        font-size: 72px;
        letter-spacing: -12px;
        left: 230px;
        top: 100px;
        position: absolute;
        text-shadow: -6px 6px 0px black;
        z-index: 2;
      }

      .bullet {
        width: 60px;
        align-self: center;
        position: relative;
      }

      #kickAnimWrap {
        position: absolute;
        inset: 0;
        z-index: 1;
        pointer-events: none;
      }
      #kickAnimWrap img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        position: absolute;
        left: 0;
        top: 0;
      }
    </style>
  </head>

  <body>
    <div id="clock">
      <span id="hh">12</span><span id="sep">!</span><span id="mm">00</span>
    </div>

    <div
      style="
        display: flex;
        flex-direction: row;
        position: absolute;
        bottom: 64px;
        left: 80px;
        gap: 24px;
      "
    >
      <img src="bullet.svg" class="bullet" />
      <img src="bullet.svg" class="bullet" />
      <img src="bullet.svg" class="bullet" />
      <img src="bullet.svg" class="bullet" />
      <img src="bullet.svg" class="bullet" />
      <img src="bullet.svg" class="bullet" />
    </div>

    <img src="time.svg" style="width: 400px; top: 76px; left: 80px" />
    <img
      src="kick.svg"
      style="width: 440px; bottom: 72px; left: 50%; transform: translateX(-50%)"
    />

    <div id="kickAnimWrap">
      <img id="kickAnim" alt="kick" />
    </div>

    <script>
      // --- clock ---
      const hhEl = document.getElementById("hh");
      const mmEl = document.getElementById("mm");
      const sepEl = document.getElementById("sep");

      function pad2(n) {
        return String(n).padStart(2, "0");
      }

      function updateClock() {
        const now = new Date();
        let h = now.getHours();
        const m = now.getMinutes();
        h = h % 12;
        if (h === 0) h = 12;
        hhEl.textContent = String(h);
        mmEl.textContent = pad2(m);
      }
      sepEl.style.visibility = "visible";
      updateClock();
      setInterval(updateClock, 2000);

      // --- kick animation preload + replay ---
      let kickImg = document.getElementById("kickAnim");
      let kickBlobUrl = null;

      const COOLDOWN_MS = 200;
      let lastKickAt = 0;

      (async function preloadKick() {
        try {
          console.log("[overlay] preloading kick-once.webp...");
          const res = await fetch("kick-once.webp", { cache: "force-cache" });
          console.log("[overlay] kick-once.webp status:", res.status);
          const blob = await res.blob();
          kickBlobUrl = URL.createObjectURL(blob);

          kickImg.src = kickBlobUrl;
          kickImg.decoding = "async";
          console.log("[overlay] kick-once.webp preloaded OK");
        } catch (e) {
          console.error("[overlay] preload failed:", e);
        }
      })();

      function playKickOnce() {
        const now = Date.now();
        if (now - lastKickAt < COOLDOWN_MS) return;
        lastKickAt = now;

        if (!kickBlobUrl) return;

        const blank =
          "data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs=";

        kickImg.src = blank;

        requestAnimationFrame(() => {
          requestAnimationFrame(() => {
            kickImg.src = kickBlobUrl;
          });
        });
      }

      window.addEventListener("beforeunload", () => {
        if (kickBlobUrl) URL.revokeObjectURL(kickBlobUrl);
      });

      // --- realtime: Supabase Broadcast ---
      const SUPABASE_URL = "https://rcwvicblzidaukglxquu.supabase.co";
      const SUPABASE_ANON_KEY =
        "sb_publishable_7to8QZuk22ORD8SnfiSRjg_U7f7EeQ0";

      const CHANNEL = "angerfoot-kick";
      const EVENT = "kick";

      (async () => {
        try {
          console.log("[overlay] realtime init...");

          const { createClient } =
            await import("https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm");

          const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
            realtime: { params: { eventsPerSecond: 20 } },
          });

          const channel = supabase.channel(CHANNEL);

          channel.on("broadcast", { event: EVENT }, (payload) => {
            console.log("[overlay] GOT KICK:", payload);
            playKickOnce();
          });

          channel.subscribe((status) => {
            console.log("[overlay] realtime status:", status);
          });
        } catch (e) {
          console.error("[overlay] realtime setup failed:", e);
        }
      })();
    </script>
  </body>
</html>
